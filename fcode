#!/bin/bash

# fcode - Project Generator
# Version: 1.0.0
# Usage: fcode init [folder_name]

set -e

VERSION="1.0.0"
REPO_BASE_URL="https://raw.githubusercontent.com/ClarkeFL/stack_init/main"

COMMAND=$1
PROJECT_NAME=$2

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

log() {
    echo -e "${BLUE}[fcode]${NC} $1"
}

success() {
    echo -e "${GREEN}[success]${NC} $1"
}

error() {
    echo -e "${RED}[error]${NC} $1"
    exit 1
}

check_bun() {
    if ! command -v bun &> /dev/null; then
        log "Bun is not installed. Installing Bun..."
        curl -fsSL https://bun.sh/install | bash
        export BUN_INSTALL="$HOME/.bun"
        export PATH="$BUN_INSTALL/bin:$PATH"
    fi
}

generate_svelte_config() {
    cat <<EOF > svelte.config.js
import adapter from '@sveltejs/adapter-static';
import { vitePreprocess } from '@sveltejs/vite-plugin-svelte';

/** @type {import('@sveltejs/kit').Config} */
const config = {
	preprocess: vitePreprocess(),

	kit: {
		adapter: adapter({
			pages: '../backend/build',
			assets: '../backend/build',
			fallback: 'index.html',
			precompress: false,
			strict: true
		})
	}
};

export default config;
EOF
}

generate_vite_config() {
    cat <<EOF > vite.config.js
import { sveltekit } from '@sveltejs/kit/vite';
import tailwindcss from '@tailwindcss/vite';
import { defineConfig } from 'vite';

export default defineConfig({
	plugins: [sveltekit(), tailwindcss()]
});
EOF
}

generate_package_json() {
    cat <<EOF > package.json
{
  "name": "frontend",
  "version": "0.0.1",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "vite dev",
    "build": "vite build",
    "preview": "vite preview",
    "prepare": "svelte-kit sync || echo ''"
  },
  "devDependencies": {
    "@sveltejs/adapter-static": "^3.0.0",
    "@sveltejs/kit": "^2.0.0",
    "@sveltejs/vite-plugin-svelte": "^5.0.0",
    "@tailwindcss/vite": "^4.0.0",
    "svelte": "^5.0.0",
    "tailwindcss": "^4.0.0",
    "vite": "^6.0.0"
  }
}
EOF
}



generate_src_files() {
    mkdir -p src/routes
    
    # app.css (Tailwind v4)
    cat <<EOF > src/app.css
@import "tailwindcss";
EOF

    # app.html
    cat <<EOF > src/app.html
<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" href="%sveltekit.assets%/favicon.png" />
		<meta name="viewport" content="width=device-width" />
		%sveltekit.head%
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents">%sveltekit.body%</div>
	</body>
</html>
EOF

    # +layout.svelte (Import CSS)
    cat <<EOF > src/routes/+layout.svelte
<script>
	import '../app.css';
</script>

<slot />
EOF

    # +layout.js
    cat <<EOF > src/routes/+layout.js
export const prerender = true;
export const ssr = false;
EOF

    # +page.svelte (Minimal)
    cat <<EOF > src/routes/+page.svelte
<script>
	let count = \$state(0);
</script>

<h1>Svelte 5 + FastAPI</h1>
<p>Edit src/routes/+page.svelte to get started</p>
<button onclick={() => count++}>
	Clicks: {count}
</button>
EOF
}

generate_fastapi() {
    cat <<EOF > app.py
from fastapi import FastAPI
from fastapi.staticfiles import StaticFiles
from fastapi.responses import FileResponse
import os

app = FastAPI()

BUILD_DIR = os.path.join(os.path.dirname(__file__), "build")

# Example API endpoint
@app.get("/api/hello")
async def hello():
    return {"message": "Hello from FastAPI!"}

# Mount static files
if os.path.exists(os.path.join(BUILD_DIR, "_app")):
    app.mount("/_app", StaticFiles(directory=os.path.join(BUILD_DIR, "_app")), name="_app")

# Serve frontend
@app.get("/{full_path:path}")
async def serve_frontend(full_path: str):
    """
    Serve static files and handle SPA routing.
    
    For multi-page apps, uncomment the following:
    # Try exact file match
    # file_path = os.path.join(BUILD_DIR, full_path)
    # if os.path.exists(file_path) and os.path.isfile(file_path):
    #     return FileResponse(file_path)
    #
    # Try .html extension
    # html_file = os.path.join(BUILD_DIR, f"{full_path}.html")
    # if os.path.exists(html_file):
    #     return FileResponse(html_file)
    """
    if full_path == "":
        full_path = "index.html"
    
    file_path = os.path.join(BUILD_DIR, full_path)
    if os.path.exists(file_path) and os.path.isfile(file_path):
        return FileResponse(file_path)
    
    # Fallback to index.html for SPA routing
    return FileResponse(os.path.join(BUILD_DIR, "index.html"))

if __name__ == "__main__":
    import uvicorn
    uvicorn.run("app:app", host="0.0.0.0", port=8000, reload=True)
EOF

    cat <<EOF > requirements.txt
fastapi
uvicorn[standard]
EOF
}

validate_project_name() {
    if [ -n "$1" ]; then
        # Check for invalid characters in project name
        if [[ "$1" =~ [^a-zA-Z0-9_-] ]]; then
            error "Project name contains invalid characters. Use only letters, numbers, hyphens, and underscores."
        fi
    fi
}

show_version() {
    echo "fcode version $VERSION"
}

check_bun_version() {
    if command -v bun &> /dev/null; then
        BUN_VERSION=$(bun --version 2>/dev/null || echo "unknown")
        log "Using Bun version: $BUN_VERSION"
        log "Check https://bun.sh for latest version"
    fi
}

check_update() {
    log "Checking for updates..."
    
    # Fetch latest version
    LATEST_VERSION=$(curl -fsSL "$REPO_BASE_URL/VERSION" 2>/dev/null | tr -d '\n\r' || echo "")
    
    if [ -z "$LATEST_VERSION" ]; then
        error "Failed to check for updates. Check your internet connection."
    fi
    
    if [ "$VERSION" = "$LATEST_VERSION" ]; then
        success "Already on latest version ($VERSION)"
        check_bun_version
        exit 0
    fi
    
    log "New version available: $VERSION → $LATEST_VERSION"
    echo ""
    echo "Changelog (recent changes):"
    curl -fsSL "$REPO_BASE_URL/CHANGELOG.md" 2>/dev/null | head -20 || echo "Could not fetch changelog"
    echo ""
    
    read -p "Update now? (y/n): " confirm
    if [ "$confirm" != "y" ]; then
        log "Update cancelled"
        exit 0
    fi
    
    perform_update "$LATEST_VERSION"
}

perform_update() {
    LATEST_VERSION=$1
    INSTALL_DIR="/usr/local/bin"
    SCRIPT_NAME="fcode"
    SCRIPT_PATH="$INSTALL_DIR/$SCRIPT_NAME"
    BACKUP_PATH="$INSTALL_DIR/${SCRIPT_NAME}.backup"
    
    log "Creating backup..."
    if [ -w "$SCRIPT_PATH" ]; then
        cp "$SCRIPT_PATH" "$BACKUP_PATH"
    else
        sudo cp "$SCRIPT_PATH" "$BACKUP_PATH"
    fi
    
    log "Downloading latest version..."
    TEMP_FILE=$(mktemp)
    if ! curl -fsSL "$REPO_BASE_URL/fcode" -o "$TEMP_FILE"; then
        error "Failed to download update"
    fi
    
    log "Installing update..."
    if [ -w "$SCRIPT_PATH" ]; then
        mv "$TEMP_FILE" "$SCRIPT_PATH"
        chmod +x "$SCRIPT_PATH"
    else
        sudo mv "$TEMP_FILE" "$SCRIPT_PATH"
        sudo chmod +x "$SCRIPT_PATH"
    fi
    
    success "Updated successfully! ($VERSION → $LATEST_VERSION)"
    log "Backup saved at: $BACKUP_PATH"
    log "Run 'fcode rollback' to restore previous version if needed"
    echo ""
    check_bun_version
}

rollback_update() {
    INSTALL_DIR="/usr/local/bin"
    SCRIPT_NAME="fcode"
    SCRIPT_PATH="$INSTALL_DIR/$SCRIPT_NAME"
    BACKUP_PATH="$INSTALL_DIR/${SCRIPT_NAME}.backup"
    
    if [ ! -f "$BACKUP_PATH" ]; then
        error "No backup found at $BACKUP_PATH"
    fi
    
    log "Backup found: $BACKUP_PATH"
    echo ""
    read -p "Restore previous version? (y/n): " confirm
    if [ "$confirm" != "y" ]; then
        log "Rollback cancelled"
        exit 0
    fi
    
    log "Restoring previous version..."
    if [ -w "$SCRIPT_PATH" ]; then
        cp "$BACKUP_PATH" "$SCRIPT_PATH"
        chmod +x "$SCRIPT_PATH"
    else
        sudo cp "$BACKUP_PATH" "$SCRIPT_PATH"
        sudo chmod +x "$SCRIPT_PATH"
    fi
    
    success "Rollback successful!"
    log "Previous version restored"
}

init_project() {
    check_bun
    validate_project_name "$PROJECT_NAME"

    if [ -n "$PROJECT_NAME" ]; then
        log "Creating project in $PROJECT_NAME..."
        mkdir -p "$PROJECT_NAME"
        cd "$PROJECT_NAME"
    else
        log "Initializing project in current directory..."
    fi

    # Root structure
    mkdir -p frontend
    mkdir -p backend

    # --- Frontend ---
    log "Setting up Svelte 5 (Frontend)..."
    cd frontend
    generate_package_json
    generate_svelte_config
    generate_vite_config
    generate_src_files
    
    log "Installing frontend dependencies with bun..."
    if ! bun install; then
        error "Failed to install frontend dependencies"
    fi
    
    cd ..

    # --- Backend ---
    log "Setting up FastAPI (Backend)..."
    cd backend
    generate_fastapi
    cd ..

    # --- Root Helpers ---
    cat <<EOF > package.json
{
  "name": "fcode-project",
  "private": true,
  "scripts": {
    "dev:front": "cd frontend && bun run dev",
    "dev:back": "cd backend && python app.py",
    "build": "cd frontend && bun run build",
    "start": "cd backend && python app.py"
  }
}
EOF
    
    # Gitignore
    cat <<EOF > .gitignore
node_modules
.DS_Store
__pycache__
.venv
venv
.svelte-kit
build
.env
EOF

    success "Project initialized successfully!"
    echo ""
    echo "To get started:"
    if [ -n "$PROJECT_NAME" ]; then
        echo "  cd $PROJECT_NAME"
    fi
    echo ""
    echo "1. (Optional) Create Python venv:"
    echo "   cd backend && python -m venv venv"
    echo "   source venv/bin/activate"
    echo "   pip install -r requirements.txt"
    echo ""
    echo "2. Build frontend:"
    echo "   cd frontend && bun run build"
    echo ""
    echo "3. Run backend:"
    echo "   cd backend && python app.py"
    echo ""
    echo "4. Open http://localhost:8000"
    echo ""
    echo "Note: Requires Python 3.9+"
}

if [ "$COMMAND" = "init" ]; then
    init_project
elif [ "$COMMAND" = "update" ]; then
    check_update
elif [ "$COMMAND" = "rollback" ]; then
    rollback_update
elif [ "$COMMAND" = "version" ] || [ "$COMMAND" = "--version" ] || [ "$COMMAND" = "-v" ]; then
    show_version
else
    echo "Usage: fcode <command> [options]"
    echo ""
    echo "Commands:"
    echo "  init [folder_name]  Initialize a new project"
    echo "  update              Update fcode to latest version"
    echo "  rollback            Restore previous version from backup"
    echo "  version             Show current version"
    echo ""
    echo "Examples:"
    echo "  fcode init myapp    Create project in 'myapp' folder"
    echo "  fcode init          Create project in current directory"
    exit 1
fi
